<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head}">
    <meta charset="UTF-8">
    <title>Moodchart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


</head>
<body>
<div th:replace="~{fragments :: logo}"></div>

<div><h1>Report</h1></div>
<div class="flex-container">


    <div class="row justify-content-center">

        <div class="col-md-4  col-sm-12 dash-canva "> <h3 class="chart-title">Behaviour</h3> <canvas id="behaviourChart"></canvas>
        </div>
        <div class="col-md-4 col-sm-12 dash-canva "><h3 class="chart-title">Sympyoms</h3> <canvas id="symptomsChart"> </canvas></div>

    </div>
    <div class="row justify-content-center">

        <div class="col-md-4 col-sm-12 dash-canva bg-tester"> <h3 class="chart-title">Day Rating</h3></div>
        <div class="col-md-4 col-sm-12 dash-canva bg-tester"> <h3 class="chart-title">Side Effects</h3>test</div>

    </div>


</div>

<script onload="fetchData()" src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    //fetch function
    async function fetchData(){
        const url = 'http://localhost:8080/api/reports/user-report.json';
        const response = await fetch(url);
        //wait until the request has been completed
        const dataPoints = await response.json();
        console.log(dataPoints);
        return dataPoints;
    };

    fetchData().then(dataPoints => {
        // get user data, in this case I'm assuming we are filtering for a single user
        const user = dataPoints[0];

        // the labels are going to be date
        const labels = user.reports.map(function(value) {
            const dt = new Date(value.date);
            return dt.toLocaleDateString();
        });



        // this can just be replicated for symptoms
        const behaviours = ['Anger','Fear','Trust','Disgust','Sadness','Anticipation','Joy','Surprise'];
        const datasets = behaviours.map(function(behaviourName){
            const data = user.reports.map(function(value){
                return value.behaviour[behaviourName];
            });
            return {
                label: behaviourName,
                data: data,
                borderWidth: 1
            };
        });


        //joining date and behaivoural date
        const allBehaviourData = [];
        for (let i=0; i <labels.length; ++i){
            allBehaviourData.push({
                labelX: labels[i],//date
                dataY: datasets[i]//data
                });
        }

        allBehaviourData.sort((a,b) => a.labelX - b.labelX);

        const sortBehaviourDate = allBehaviourData.map(e => e.labelX);
        const sortedBehaviour = allBehaviourData.map(e => e.dataY);

        //generating behaviour chart
        behaviourChart.config.data.labels = sortBehaviourDate;
        behaviourChart.config.data.datasets = sortedBehaviour;
        behaviourChart.update();

        //SYMPTOMS CHART//


        const symptoms = ['Appetite','Nauseus','Headache','Somnolence','Weakness','Bodyache','Confusional state','Vomit'];
        const sympDatasets = symptoms.map(function(symptomName){
            const sympData = user.reports.map(function(value){
                return value.symptom[symptomName];
            });
            return {
                label: symptomName,
                data: sympData,
                borderWidth: 1
            };
        });


        //joining date and behaivoural date
        const allSymptomData = [];
        for (let i=0; i <labels.length; ++i){
            allSymptomData.push({
                labelX: labels[i],//date
                dataY: sympDatasets[i]//data
            });
        }

        allSymptomData.sort((a,b) => a.labelX - b.labelX);

        const sortSymptomDate = allSymptomData.map(e => e.labelX);
        const sortedSymptoms = allSymptomData.map(e => e.dataY);

        //generating symptoms chart
        symptomsChart.config.data.labels = sortSymptomDate;
        symptomsChart.config.data.datasets = sortedSymptoms;
        symptomsChart.update();
    });

    const config = {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }

            }
        }
    }

    //creating behaviour chart
    const behaviourChart = new Chart(
        document.getElementById('behaviourChart'),
        config
    );

    //creating symptoms chart

    const symptomsChart = new Chart(
        document.getElementById('symptomsChart'),
        config
    );


    //Day rating graph

    const dayRating = user.reports.map(function(value) {
        const dr = value.dayClassification;
        return dr;
    });




</script>

<div class="container-fluid sticky-bottom">
    <footer th:replace="~{fragments :: footer}"></footer>
</div>
</body>
</html>

<script
        src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>