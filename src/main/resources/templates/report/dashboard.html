<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="~{fragments :: head}">
    <title id="pageTitle">Dashboard</title>
</head>
</head>
<body>
<div th:replace="~{fragments :: logo}"></div>

<div class="top-title"><h1>Report Dashboard</h1></div>

<div class="row justify-content-center mx-5">

    <label>Start: <input class="form-control" type="date"
                         value="datePicker"
                         id="start"></label>

    <label class="ml-3"> End:
        <input class="form-control" type="date"
               value="datePicker"
               id="end">
    </label>
    <div class="col-3 mt-2">
        <button class="update-btn mt-2" onclick="filterDate()">Filter</button>

        <button class="delete-btn mt-2" onclick="resetDate()">Reset</button>
    </div>
</div>

<div class="flex-container mt-5 mb-3">


    <div class="row justify-content-center">

        <div class="col-xl-4 col-lg-6 col-12 col-md-6  col-sm-12 dash-canva ">
            <h3 class="chart-title">Behavior</h3>
            <canvas id="behaviourChart"></canvas>
        </div>
        <div class="col-xl-4 col-lg-6 col-12 col-md-6 col-sm-12 dash-canva "><h3 class="chart-title">Symptoms</h3>
            <canvas id="symptomsChart"></canvas>
        </div>

    </div>
    <div class="row justify-content-center">

        <div class="col-xl-4 col-lg-6 col-12 col-md-6 col-sm-12 dash-canva "><h3 class="chart-title">Day Rating</h3>
            <canvas id="dayChart"></canvas>
        </div>
        <!--        <div class="col-md-4 col-sm-12 dash-canva bg-tester"><h3 class="chart-title">Side Effects</h3>test</div>-->
    </div>

    <div onload="fetchData()"></div>
</div>

<!--CREATING THE DASHBOARD VIA CHARTS API-->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    //fetch function
    async function fetchData() {
        const url = 'http://localhost:8080/api/reports/user-report.json';
        const response = await fetch(url);
        //wait until the request has been completed
        const dataPoints = await response.json();
        console.log(dataPoints);
        return dataPoints;
    };

    fetchData().then(dataPoints => {
        // get user data, in this case I'm assuming we are filtering for a single user
        const user = dataPoints[0];

        // the labels are going to be date
        const labels = user.reports.map(function (value) {
            return new Date(value.date).toLocaleDateString();
        });




        //BEHAVIOUR DATA CHART//
        const behaviors = ['Anger', 'Fear', 'Trust', 'Disgust', 'Sadness', 'Anticipation', 'Joy', 'Surprise'];
        const datasets = behaviors.map(function (behaviorName) {
            const data = user.reports.map(function (value) {
                return value.behaviour[behaviorName];
            });
            return {
                label: behaviorName,
                data: data,
                borderWidth: 1
            };
        });


        const size = datasets.length;

        //generating behaviour chart
        behaviorChart.config.data.labels = labels;
        behaviorChart.config.data.datasets = datasets;
        behaviorChart.update();

        //SYMPTOMS DATA CHART//
        const symptoms = ['Appetite', 'Nauseus', 'Headache', 'Somnolence', 'Weakness', 'Bodyache', 'Confusional_state', 'Vomit'];
        //MAPPING THE DATASET
        const sympDatasets = symptoms.map(function (symptomName) {
            const sympData = user.reports.map(function (value) {
                return value.symptom[symptomName];
            });
            console.log(sympData);
            if (symptomName == "Confusional_state") {
                symptomName = "Confusional State";
            }
            return {
                label: symptomName,
                data: sympData,
                borderWidth: 1
            };
        });


        //generating symptoms chart
        symptomsChart.config.data.labels = labels;
        symptomsChart.config.data.datasets = sympDatasets;
        symptomsChart.update();

        //DAY RATING GRAPH  - var dayClassification
        const dayData = user.reports.map(function (value) {
            return value.dayClassification;
        });

        const dayDataset = [{
            label: 'Day Classification',
            data: dayData,
            borderWidth: 1
        }];

        console.log(datasets.length);


        // generating symptoms chart
        dayChart.config.data.labels = labels;
        dayChart.config.data.datasets = dayDataset;
        dayChart.update();
    });


    //GENERATING CHARTS


    const behaviorChart = new Chart(

        document.getElementById('behaviourChart'),
        {

            type: 'line',
            options: {
                responsive: true,
                scales: {
                    x:{
                        min: (ctx) => {

                            return ctx.chart.data.labels[0];
                        },
                        max: (ctx) => {
                            return ctx.chart.data.labels[6];
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 6
                    }
                }
            }
        }
    );

    //creating symptoms chart
    const symptomsChart = new Chart(
        document.getElementById('symptomsChart'),
        {
            type: 'line',
            options: {
                responsive: true,
                scales: {
                    x: {
                        min: (ctx) => {
                            return ctx.chart.data.labels[0];
                        },
                        max: (ctx) => {
                            return ctx.chart.data.labels[30];
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 6
                    }
                }
            }
        }
    );

    //Day rating graph
    const dayChart = new Chart(
        document.getElementById('dayChart'),
        {
            type: 'line',
            options: {
                responsive: true,
                scales: {
                    x: {
                        min: (ctx) => {
                            return ctx.chart.data.labels[0];
                        },
                    },
                    y: {
                        beginAtZero: true,
                        max: 6
                    }
                }
            }
        }
    );


    //FILTER

    function filterDate() {

        const start = new Date(document.getElementById('start').value);
        const end = new Date(document.getElementById('end').value);
        console.log(start);
        console.log(end);


        symptomsChart.config.options.scales.x.min = start;
        symptomsChart.config.options.scales.x.max = end;

        behaviorChart.config.options.scales.x.min = start;
        behaviorChart.config.options.scales.x.max = end;

        dayChart.config.options.scales.x.min = start;
        dayChart.config.options.scales.x.max = end;

        symptomsChart.update();
        behaviorChart.update();
        dayChart.update();
    }
</script>

<div class="container-fluid sticky-bottom">
    <footer th:replace="~{fragments :: footer}"></footer>
</div>
</body>
</html>

<!--chart.js api scripts-->

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

